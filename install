#!/bin/bash
# shellcheck disable=SC2046,SC2086
set -eux

# このスクリプトのディレクトリ位置を保持する。
# 戻ったり他のスクリプトの参照に使う。
dotfiles_dir=$(realpath $(dirname "$0"))
cd $dotfiles_dir

# 標準的なUnix環境向けに設定ファイルをコピーする。
function install-conf-file() {
  cd $dotfiles_dir
  # 現在のユーザのホームディレクトリを展開する。
  home_dir=~

  # `/etc/`が存在しない環境で`/etc/`にマッピングしないようにする。
  if [ -d "/etc/" ]; then
    find_dir=(etc home/user)
  else
    find_dir=(home/user)
  fi

  # 設定ファイルをリンクする。
  while IFS= read -r -d '' f
  do
    # 後々正しい相対パスにするために絶対パスを取得する。
    real=$(realpath $f)
    # home/userは~/にマッピングします。
    if [[ $f == home/user* ]]; then
      conf_dir=$(dirname ${f/home\/user/$home_dir})
      mkdir -p $conf_dir
      # マウントしても正常にパスが辿れるようにcdして設置する回りくどい方法を取っている。
      cd $conf_dir
      ln -sfv $(realpath --relative-to=. $real) .
    else # その他のディレクトリ(今はetcしかないが)はフルパスをマッピングする。
      conf_dir=/$(dirname $f)
      # etcでの操作にはroot権限が必要になる。
      sudo mkdir -p $conf_dir
      cd $conf_dir
      sudo ln -sfv $(realpath --relative-to=. $real) .
    fi
    cd $dotfiles_dir
  done < <(find "${find_dir[@]}" -type f -print0)
}

# git-hooksを実行可能にする。
function install-git-hooks() {
  cd $dotfiles_dir/git-hooks/
  yarn install --immutable

  # gitの認証情報保存設定をソフトウェアのインストール状態によって変更する。
  cd ~/.config/git/

  if hash git-credential-libsecret 2>/dev/null; then
    # Gentooなど、git-credential-libsecretを素直にパッケージマネージャからPATHに入れられる環境。
    ln -sfv config.credential.libsecret.relative config.credential
  elif [[ -x /usr/share/doc/git/contrib/credential/libsecret/git-credential-libsecret ]]; then
    # Ubuntuなど、自動でPATHが通らない環境。
    ln -sfv config.credential.libsecret.absolute config.credential
  elif [[ -x /Library/Developer/CommandLineTools/usr/libexec/git-core/git-credential-osxkeychain ]]; then
    # macOS。
    ln -sfv config.credential.osxkeychain.relative config.credential
  elif [[ -x /mnt/c/Program\ Files/Git/mingw64/bin/git-credential-manager.exe ]]; then
    # WSL環境など、Windows側に認証情報を任せる場合。Magitから使うとコンソールがポップアップしてくるので使いたくない。
    ln -sfv config.credential.manager.absolute.windows.wsl config.credential
  elif [[ -x "C:\\Program Files\\Git\\mingw64\\bin\\git-credential-manager.exe" ]]; then
    # MSYS2など、Windowsネイティブで利用する場合。
    ln -sfv config.credential.manager.absolute.windows.native config.credential
  elif hash git-credential-manager 2>/dev/null; then
    # マルチプラットフォームでGCMを使う場合。
    ln -sfv config.credential.manager.relative config.credential
  else
    # いずれも使えない場合のフォールバック。
    # 早めにセットアップして入力不要にするべき。
    ln -sfv config.credential.cache.relative config.credential
  fi
}

# コマンドによりレジストリ的なものの設定を行う。
function install-by-command() {
  cd $dotfiles_dir
  if hash gsettings 2>/dev/null; then
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
  fi
}

install-conf-file
install-git-hooks
install-by-command
